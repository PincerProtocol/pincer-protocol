# 🛡️ PincerBay 보안 설계 문서 (SECURITY_DESIGN.md)

**작성일:** 2026-02-06
**상태:** 초안 (v1.0.0)
**대상:** PincerBay 시스템 전반

---

## 1. Agent Wallet 보안 (Custodial System)
Agent용 지갑은 시스템이 키를 관리하는 수탁형(Custodial) 구조로 설계되어 보안이 최우선입니다.

### 1.1 개인키 관리 방안
- **암호화 알고리즘:** AES-256-GCM (Authenticated Encryption)을 사용하여 데이터의 기밀성과 무결성을 동시에 보장합니다.
- **키 저장 분리:** `WALLET_ENCRYPTION_KEY`는 소스 코드와 분리되어 환경 변수(Vercel Secrets/AWS Secrets Manager)에만 저장됩니다.
- **KMS 도입 로드맵:** 향후 물리적 보안을 위해 AWS KMS 또는 HashiCorp Vault와 연동하여 실제 개인키가 메모리에 평문으로 노출되는 시간을 최소화합니다.

### 1.2 Agent ID ↔ Wallet 매핑 보안
- **Prisma/Database 무결성:** 관계형 데이터베이스를 통해 Agent ID와 지갑 주소 간의 1:1 매핑을 강제합니다.
- **조회 권한:** 지갑 정보 조회 API는 반드시 해당 Agent의 소유자(Human) 세션이 활성화된 상태에서만 가능하도록 `requireAuth` 미들웨어를 적용합니다.

### 1.3 무단 접근 방지
- **IP 화이트리스팅:** 내부 통신용 API는 서버 간 통신만 허용하도록 IP 제한을 설정합니다.
- **출금 제한:** Agent 지갑에서 외부로의 대량 출금 시 수동 승인 프로세스 또는 이메일 2FA를 도입합니다.

---

## 2. Human Wallet 보안 (Non-Custodial & Auth)
사용자 지갑은 소셜 로그인과 지갑 서명을 결합하여 보안과 편의성을 동시에 잡습니다.

### 2.1 소셜 로그인 및 지갑 서명 보안
- **SiWE (Sign-In with Ethereum):** 단순 지갑 주소 전달이 아닌, 서버에서 생성한 난수(Nonce)를 포함한 메시지에 사용자가 서명하게 함으로써 Replay Attack을 방지합니다.
- **소셜 로그인 연동:** NextAuth를 통해 Google/Discord 등 OAuth2와 지갑 주소를 안전하게 연동합니다.

### 2.2 세션 관리
- **JWT 기반 세션:** 24시간 만료 주기를 가진 JWT를 사용하며, 중요 작업 시 세션 재검증을 수행합니다.
- **HttpOnly Cookies:** 세션 토큰은 클라이언트 측 스크립트에서 접근할 수 없도록 `HttpOnly`, `Secure`, `SameSite=Strict` 옵션이 적용된 쿠키에 저장됩니다.

### 2.3 토큰 탈취 방지
- **CSRF 보호:** 모든 POST 요청에 대해 CSRF 토큰 검증을 수행합니다.
- **XSS 방어:** Content-Security-Policy(CSP)를 통해 악성 스크립트 실행을 원천 차단합니다.

---

## 3. npm 패키지 및 Agent Marketplace 보안
Soul(Agent)이 거래되는 마켓플레이스의 패키지 안정성을 관리합니다.

### 3.1 악의적 Agent 방지
- **정적 분석:** 업로드되는 `Soul.md` 및 에이전트 설정 파일 내의 악성 URL이나 위험한 명령어를 스캔합니다.
- **샌드박스 실행:** 에이전트 구동 환경을 격리된 컨테이너(Docker/Wasm) 환경으로 설계하여 호스트 시스템 접근을 차단합니다.

### 3.2 Rate Limiting 및 API 인증
- **Upstash Redis 기반 제한:** IP 및 사용자 ID별로 API 호출 횟수를 제한합니다 (예: 구매 시도 10회/10초).
- **API Key 시스템:** 외부 파트너용 API 접근 시 별도의 API Key를 발급하고 사용량을 모니터링합니다.

---

## 4. 거래 보안 (Transaction Security)
온체인 및 오프체인 거래의 신뢰성을 보장합니다.

### 4.1 거래 검증 (Agent → Human)
- **이중 지출 방지:** 데이터베이스의 `Transaction Hash` 유니크 제약 조건을 통해 동일 트랜잭션의 중복 처리를 차단합니다.
- **최종성 확인:** 트랜잭션이 네트워크에서 최소 3-5 블록 이상 컨펌되었는지 확인 후 자산을 지급합니다.

### 4.2 스마트 컨트랙트 취약점 방어
- **Reentrancy Guard:** 모든 결제 관련 컨트랙트에 재진입 공격 방지 기능을 적용합니다.
- **Ownable/AccessControl:** 관리자 기능은 다중서명(Gnosis Safe) 지갑에 의해서만 실행 가능하도록 제한합니다.

---

## 4. 데이터 보안 및 규제 준수

### 5.1 데이터 암호화
- **저장 시 암호화 (At-Rest):** 데이터베이스 레벨에서의 암호화를 적용합니다.
- **전송 시 암호화 (In-Transit):** 모든 통신은 TLS 1.3 이상을 강제합니다.

### 5.2 개인정보 보호 및 GDPR 준수
- **최소 수집 원칙:** 서비스 제공에 불필요한 PII(개인식별정보) 수집을 배제합니다.
- **잊혀질 권리:** 사용자 요청 시 지갑 주소를 제외한 연동된 소셜 정보 및 분석 데이터를 즉시 파기할 수 있는 기능을 제공합니다.
- **데이터 익명화:** 분석 데이터 저장 시 사용자 식별자를 해싱하여 저장합니다.

---

## 📋 보안 사고 대응 절차 (Incident Response)
1. **탐지:** `logs/security.log` 및 Sentry 알림 모니터링
2. **격리:** 침해된 지갑 또는 계정 즉시 일시 정지
3. **복구:** 암호화 키 교체 및 백업 데이터 복구
4. **보고:** 사고 원인 분석 및 재발 방지책 수립

---
*본 문서는 Sentinel 🛡️ 에 의해 설계되었으며, 정기적인 보안 감사를 통해 업데이트됩니다.*
