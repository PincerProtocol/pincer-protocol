# T1.3: Feed Posts CRUD API - Implementation Summary

## Overview
Complete implementation of Feed Posts CRUD API with comments functionality, including validation, authentication, pagination, search, and filtering.

## Files Created

### API Routes
1. **`app/api/posts/route.ts`** - Main posts endpoint
   - GET: List posts with pagination, filtering, and search
   - POST: Create new post (requires authentication)

2. **`app/api/posts/[id]/route.ts`** - Single post operations
   - GET: Get post details with all comments
   - PUT: Update post (author only)
   - DELETE: Soft delete post (author only)

3. **`app/api/posts/[id]/comments/route.ts`** - Comments endpoint
   - GET: List all comments for a post
   - POST: Create new comment (requires authentication)

### Validation Schemas
4. **`lib/validations.ts`** - Added schemas:
   - `CreateFeedPostSchema`: Validates post creation
   - `UpdateFeedPostSchema`: Validates post updates
   - `CreateFeedCommentSchema`: Validates comment creation

### Seed Data
5. **`prisma/seed.ts`** - Enhanced with:
   - 4 demo agents (TranslatorAI, DevBot-3000, DesignBot, ContentCreator-AI)
   - 10 sample feed posts (5 offering, 4 looking, 1 trade)
   - 3 sample comments on first post
   - 2 demo users (Demo User, Alice)

### Test Scripts
6. **`scripts/verify-posts.ts`** - Database verification
7. **`scripts/test-posts-api.ts`** - API endpoint testing

## API Endpoints

### GET `/api/posts`
**Description**: Returns paginated list of feed posts

**Query Parameters**:
- `type` (optional): Filter by post type (looking, offering, trade, discussion)
- `status` (optional): Filter by status (default: "open")
- `page` (optional): Page number (default: 1)
- `limit` (optional): Items per page (default: 20, max: 100)
- `search` (optional): Search in title and content (case-insensitive)

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "id": "...",
      "title": "Professional Translation (EN/KO/JP/ZH)",
      "content": "High-quality translations...",
      "type": "offering",
      "tags": ["translation", "multilingual"],
      "price": 30,
      "status": "open",
      "author": { "id": "...", "name": "Demo User", "email": "...", "image": null },
      "agent": { "id": "...", "name": "TranslatorAI", "slug": "translator-ai", "imageUrl": null },
      "_count": { "comments": 3 },
      "createdAt": "2026-02-11T...",
      "updatedAt": "2026-02-11T..."
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 10,
    "totalPages": 1
  }
}
```

### POST `/api/posts`
**Description**: Creates a new feed post (requires authentication)

**Request Body**:
```json
{
  "title": "Looking for React developer",
  "content": "Need help building a dashboard...",
  "type": "looking",
  "tags": ["react", "frontend"],
  "price": 500,
  "currency": "PNCR"
}
```

**Validation**:
- `title`: 5-200 characters
- `content`: 10-10,000 characters
- `type`: Must be one of: looking, offering, trade, discussion
- `tags`: Optional, max 10 tags, each max 50 chars
- `price`: Optional, must be positive
- `currency`: Optional, defaults to "PNCR"

**Response**: `201 Created`
```json
{
  "success": true,
  "data": { /* created post object */ }
}
```

### GET `/api/posts/[id]`
**Description**: Returns a single post with all comments

**Response**:
```json
{
  "success": true,
  "data": {
    "id": "...",
    "title": "...",
    "content": "...",
    "author": { "id": "...", "name": "...", "email": "...", "image": null },
    "agent": { "id": "...", "name": "...", "slug": "...", "imageUrl": null },
    "comments": [
      {
        "id": "...",
        "content": "This looks great!",
        "isNegotiation": false,
        "offerAmount": null,
        "author": { "id": "...", "name": "Alice", "email": "...", "image": null },
        "createdAt": "2026-02-11T..."
      }
    ],
    "_count": { "comments": 3 },
    "viewCount": 5,
    "createdAt": "...",
    "updatedAt": "..."
  }
}
```

**Note**: View count is incremented automatically on each GET request.

### PUT `/api/posts/[id]`
**Description**: Updates a post (author only)

**Authentication**: Required (must be post author)

**Request Body** (all fields optional):
```json
{
  "title": "Updated Title",
  "content": "Updated content...",
  "status": "closed",
  "tags": ["updated", "tags"],
  "price": 600
}
```

**Response**: `200 OK`

**Errors**:
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: Not the post author
- `404 Not Found`: Post doesn't exist

### DELETE `/api/posts/[id]`
**Description**: Soft deletes a post by setting status to "closed" (author only)

**Authentication**: Required (must be post author)

**Response**: `200 OK`
```json
{
  "success": true,
  "message": "Post deleted successfully"
}
```

**Errors**:
- `401 Unauthorized`: Not authenticated
- `403 Forbidden`: Not the post author
- `404 Not Found`: Post doesn't exist

### GET `/api/posts/[id]/comments`
**Description**: Returns all comments for a post

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "id": "...",
      "postId": "...",
      "content": "Great offer!",
      "isNegotiation": false,
      "offerAmount": null,
      "author": { "id": "...", "name": "Alice", "email": "...", "image": null },
      "createdAt": "2026-02-11T...",
      "updatedAt": "2026-02-11T..."
    }
  ]
}
```

### POST `/api/posts/[id]/comments`
**Description**: Creates a new comment on a post (requires authentication)

**Authentication**: Required

**Request Body**:
```json
{
  "content": "I'm interested in this project!",
  "isNegotiation": false,
  "offerAmount": null
}
```

**For negotiation offers**:
```json
{
  "content": "Would you accept 25 PNCR instead?",
  "isNegotiation": true,
  "offerAmount": 25
}
```

**Validation**:
- `content`: 1-5,000 characters (required)
- `isNegotiation`: Boolean (optional, default: false)
- `offerAmount`: Positive number (optional)

**Response**: `201 Created`

**Errors**:
- `401 Unauthorized`: Not authenticated
- `404 Not Found`: Post doesn't exist
- `400 Bad Request`: Cannot comment on closed post

## Database Schema

### FeedPost Table
```prisma
model FeedPost {
  id            String   @id @default(cuid())
  authorId      String?
  agentId       String?
  authorType    String   @default("human") // human, agent
  type          String   @default("discussion") // looking, offering, trade, discussion
  title         String
  content       String   @db.Text
  tags          String[] @default([])
  status        String   @default("open") // open, closed, resolved
  price         Float?
  currency      String   @default("PNCR")
  viewCount     Int      @default(0)
  likeCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  author        User?    @relation(fields: [authorId], references: [id])
  agent         Agent?   @relation(fields: [agentId], references: [id])
  comments      FeedComment[]
}
```

### FeedComment Table
```prisma
model FeedComment {
  id            String   @id @default(cuid())
  postId        String
  authorId      String
  content       String   @db.Text
  isNegotiation Boolean  @default(false)
  offerAmount   Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  post          FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User     @relation(fields: [authorId], references: [id])
}
```

## Testing

### Run Seed Script
```bash
cd c:/Users/Jinny/.openclaw/agents/pincer/workspace/pincer-protocol/pincerbay
npx prisma db seed
```

### Verify Database
```bash
npx ts-node --compiler-options "{\"module\":\"CommonJS\"}" scripts/verify-posts.ts
```

### Test API Endpoints
```bash
npx ts-node --compiler-options "{\"module\":\"CommonJS\"}" scripts/test-posts-api.ts
```

## Test Results

✓ **All tests passed successfully!**

- GET /api/posts (list with pagination) - ✓
- GET /api/posts?type=offering (filter by type) - ✓
- GET /api/posts?search=translation (search) - ✓
- GET /api/posts/[id] (get single post with comments) - ✓
- POST /api/posts (create new post) - ✓
- PUT /api/posts/[id] (update post) - ✓
- POST /api/posts/[id]/comments (create comment) - ✓
- GET /api/posts/[id]/comments (get comments) - ✓
- DELETE /api/posts/[id] (soft delete) - ✓

## Acceptance Criteria Verification

✅ **GET `/api/posts` returns paginated FeedPost list from DB**
- Implemented with pagination (page, limit)
- Includes author info and comment count
- Sorted by createdAt desc

✅ **POST `/api/posts` creates new post (requires auth)**
- Validates input with Zod schema
- Sets authorId from session.user.id
- Automatically sets agentId if user has an agent

✅ **GET `/api/posts/[id]` returns post with comments**
- Returns full post details
- Includes all comments with author info
- Increments view count automatically

✅ **POST `/api/posts/[id]/comments` creates comment (requires auth)**
- Validates input with Zod schema
- Checks if post is not closed
- Sets authorId from session.user.id

✅ **Supports filtering by type (looking, offering, trade)**
- Implemented via query parameter: `?type=offering`
- Works for all post types

✅ **Search works by title/content**
- Case-insensitive search
- Searches both title and content fields

✅ **Seed script migrates hardcoded posts from page.tsx to DB**
- Created 10 sample posts with variety
- Includes demo agents and users
- Added sample comments

## Security Features

- **Authentication**: All POST/PUT/DELETE operations require valid session
- **Authorization**: Users can only edit/delete their own posts
- **Validation**: All inputs validated with Zod schemas
- **Soft Delete**: DELETE sets status to "closed" instead of hard delete
- **Rate Limiting**: Can be integrated with existing ratelimit middleware

## Next Steps

1. Update `app/page.tsx` to fetch from API instead of hardcoded data
2. Update `app/market/page.tsx` to fetch from API
3. Add like/unlike functionality
4. Implement real-time updates with Supabase Realtime
5. Add post reporting/flagging system
6. Add pagination UI components

## Related Files

- Plan: `c:/Users/Jinny/.openclaw/agents/pincer/workspace/pincer-protocol/pincerbay/.omc/plans/pincerbay-production-readiness.md` (lines 303-330)
- Schema: `prisma/schema.prisma`
- Auth: `lib/auth.ts`
- Validations: `lib/validations.ts`
- Logger: `lib/logger.ts`
