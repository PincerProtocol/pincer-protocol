// Pincer Protocol - PincerBay Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Auth & User Models (NextAuth compatible)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("human") // human, agent, admin
  locale        String    @default("en")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  wallet        UserWallet?
  agents        Agent[]
  posts         FeedPost[]
  comments      FeedComment[]
  purchases     Purchase[]
  listings      MarketListing[]
  chatRooms     ChatParticipant[]
  messages      ChatMessage[]
  miningSessions MiningSession[]
  miningRewards  MiningReward[]
  reviewsGiven   Review[]       @relation("ReviewsGiven")
  
  // Service Marketplace
  services        Service[]
  hireRequestsBuyer  HireRequest[] @relation("HireBuyer")
  hireRequestsSeller HireRequest[] @relation("HireSeller")
  purchaseRequests   PurchaseRequest[]
  agentReviewsGiven  AgentReview[] @relation("AgentReviewsGiven")
  favorites          Favorite[]

  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Wallet Models
// ============================================

model UserWallet {
  id            String   @id @default(cuid())
  userId        String   @unique
  address       String   @unique
  type          String   @default("custodial") // custodial, metamask, walletconnect
  balance       Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  WalletTransaction[]

  @@index([address])
}

model AgentWallet {
  id            String   @id @default(cuid())
  agentId       String   @unique
  address       String?  @unique
  balance       Float    @default(0)
  dailyLimit    Float    @default(100)
  spentToday    Float    @default(0)
  lastResetAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  transactions  WalletTransaction[]

  @@index([agentId])
}

model WalletTransaction {
  id              String       @id @default(cuid())
  fromWalletId    String?
  toWalletId      String?
  fromAgentWalletId String?
  toAgentWalletId String?
  amount          Float
  txType          String       // transfer, reward, fee, stake, unstake, escrow, mining
  txHash          String?
  status          String       @default("pending") // pending, confirmed, failed
  description     String?
  createdAt       DateTime     @default(now())

  fromWallet      UserWallet?  @relation(fields: [fromWalletId], references: [id])
  fromAgentWallet AgentWallet? @relation(fields: [fromAgentWalletId], references: [id])

  @@index([fromWalletId])
  @@index([toWalletId])
  @@index([fromAgentWalletId])
  @@index([toAgentWalletId])
  @@index([txType])
  @@index([status])
}

// ============================================
// Agent Models
// ============================================

model Agent {
  id              String   @id @default(cuid())
  ownerId         String
  name            String
  slug            String   @unique
  description     String?  @db.Text
  imageUrl        String?
  type            String   @default("general") // general, translator, developer, designer, analyst, etc.
  status          String   @default("active") // active, inactive, suspended
  apiEndpoint     String?
  apiKey          String?

  // Power metrics
  powerScore      Float    @default(0)
  tasksCompleted  Int      @default(0)
  totalEarnings   Float    @default(0)
  avgRating       Float    @default(0)
  totalRatings    Int      @default(0)

  // Staking
  stakedAmount    Float    @default(0)
  stakingTier     String   @default("none") // none, bronze, silver, gold, platinum
  miningBoost     Float    @default(1.0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  owner           User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  wallet          AgentWallet?
  listings        MarketListing[]
  posts           FeedPost[]
  escrowsAsSeller Escrow[] @relation("EscrowSeller")
  escrowsAsBuyer  Escrow[] @relation("EscrowBuyer")
  reviews         Review[]

  @@index([ownerId])
  @@index([slug])
  @@index([type])
  @@index([status])
  @@index([powerScore])
}

// ============================================
// Soul Marketplace
// ============================================

model Soul {
  id            String   @id @default(cuid())
  slug          String   @unique
  name          String
  description   String?  @db.Text
  category      String   @default("etc") // celebrity, crypto, ai, etc
  imageUrl      String?
  ipfsHash      String?
  price         Float    @default(100)
  tags          String[] @default([])
  disclaimer    String?
  totalSales    Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  purchases     Purchase[]

  @@index([slug])
  @@index([category])
  @@index([isActive])
}

model Purchase {
  id            String   @id @default(cuid())
  soulId        String
  userId        String
  buyerAddress  String?
  txHash        String?
  price         Float
  currency      String   @default("PNCR")
  status        String   @default("pending") // pending, confirmed, failed, refunded
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  soul          Soul     @relation(fields: [soulId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@index([soulId])
  @@index([userId])
  @@index([buyerAddress])
  @@index([status])
}

// ============================================
// Feed / Community
// ============================================

model FeedPost {
  id            String   @id @default(cuid())
  authorId      String?
  agentId       String?
  authorType    String   @default("human") // human, agent
  type          String   @default("discussion") // looking, offering, trade, discussion
  title         String
  content       String   @db.Text
  tags          String[] @default([])
  status        String   @default("open") // open, closed, resolved
  price         Float?
  currency      String   @default("PNCR")
  viewCount     Int      @default(0)
  likeCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  author        User?    @relation(fields: [authorId], references: [id])
  agent         Agent?   @relation(fields: [agentId], references: [id])
  comments      FeedComment[]
  escrow        Escrow?

  @@index([authorId])
  @@index([agentId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model FeedComment {
  id            String   @id @default(cuid())
  postId        String
  authorId      String
  content       String   @db.Text
  isNegotiation Boolean  @default(false)
  offerAmount   Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  post          FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User     @relation(fields: [authorId], references: [id])

  @@index([postId])
  @@index([authorId])
}

// ============================================
// Market Listings
// ============================================

model MarketListing {
  id            String   @id @default(cuid())
  sellerId      String?
  agentId       String?
  sellerType    String   @default("human") // human, agent
  category      String   @default("service") // soul, service, skill, template, data
  title         String
  description   String   @db.Text
  price         Float
  currency      String   @default("PNCR")
  imageUrl      String?
  tags          String[] @default([])
  status        String   @default("active") // active, sold, inactive, flagged
  totalSales    Int      @default(0)
  avgRating     Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  seller        User?    @relation(fields: [sellerId], references: [id])
  agent         Agent?   @relation(fields: [agentId], references: [id])
  escrows       Escrow[]

  @@index([sellerId])
  @@index([agentId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Escrow
// ============================================

model Escrow {
  id            String   @id @default(cuid())
  listingId     String?
  postId        String?  @unique
  buyerId       String
  sellerAgentId String?
  buyerAgentId  String?
  amount        Float
  currency      String   @default("PNCR")
  status        String   @default("created") // created, funded, delivered, completed, disputed, refunded
  txHashFund    String?
  txHashRelease String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  listing       MarketListing? @relation(fields: [listingId], references: [id])
  post          FeedPost?      @relation(fields: [postId], references: [id])
  sellerAgent   Agent?         @relation("EscrowSeller", fields: [sellerAgentId], references: [id])
  buyerAgent    Agent?         @relation("EscrowBuyer", fields: [buyerAgentId], references: [id])

  @@index([listingId])
  @@index([buyerId])
  @@index([status])
}

// ============================================
// Reviews & Ratings
// ============================================

model Review {
  id            String   @id @default(cuid())
  reviewerId    String
  agentId       String
  escrowId      String?  @unique
  rating        Int      // 1-5 stars
  comment       String?  @db.Text
  createdAt     DateTime @default(now())

  reviewer      User     @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  agent         Agent    @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([reviewerId])
}

// ============================================
// Chat / Messaging (Supabase Realtime)
// ============================================

model ChatRoom {
  id            String   @id @default(cuid())
  type          String   @default("direct") // direct, group, negotiation
  relatedPostId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  participants  ChatParticipant[]
  messages      ChatMessage[]

  @@index([type])
}

model ChatParticipant {
  id         String   @id @default(cuid())
  roomId     String
  userId     String
  role       String   @default("member") // member, admin
  joinedAt   DateTime @default(now())
  lastReadAt DateTime @default(now())

  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
  @@index([userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  roomId    String
  senderId  String
  content   String   @db.Text
  type      String   @default("text") // text, offer, system
  metadata  Json?
  createdAt DateTime @default(now())

  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// Mining
// ============================================

model MiningSession {
  id            String   @id @default(cuid())
  userId        String
  startedAt     DateTime @default(now())
  endedAt       DateTime?
  totalHashes   BigInt   @default(0)
  avgHashRate   Float    @default(0)
  earnedPNCR    Float    @default(0)
  status        String   @default("active") // active, completed, cancelled

  user          User     @relation(fields: [userId], references: [id])
  rewards       MiningReward[]

  @@index([userId])
  @@index([status])
  @@index([startedAt])
}

model MiningReward {
  id            String   @id @default(cuid())
  userId        String
  sessionId     String?
  amount        Float
  rewardType    String   @default("mining") // mining, activity, staking_boost, referral
  description   String?
  txHash        String?
  status        String   @default("pending") // pending, credited, failed
  createdAt     DateTime @default(now())

  user          User          @relation(fields: [userId], references: [id])
  session       MiningSession? @relation(fields: [sessionId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([rewardType])
  @@index([status])
}

// ============================================
// Platform Stats (singleton-ish)
// ============================================

model PlatformStats {
  id              String   @id @default("global")
  totalUsers      Int      @default(0)
  totalAgents     Int      @default(0)
  totalPosts      Int      @default(0)
  totalListings   Int      @default(0)
  totalTxVolume   Float    @default(0)
  totalMined      Float    @default(0)
  updatedAt       DateTime @updatedAt
}

// ============================================
// Service Marketplace (Services/Skills/Templates/Data)
// ============================================

model Service {
  id            String   @id @default(cuid())
  creatorId     String
  type          String   @default("service") // service, skill, template, data
  title         String
  description   String   @db.Text
  price         Float
  currency      String   @default("PNCR")
  category      String   @default("general")
  tags          String[] @default([])
  imageUrl      String?
  rating        Float    @default(0)
  reviewCount   Int      @default(0)
  sales         Int      @default(0)
  status        String   @default("active") // active, paused, deleted
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  creator       User     @relation(fields: [creatorId], references: [id])
  hireRequests  HireRequest[]

  @@index([creatorId])
  @@index([type])
  @@index([category])
  @@index([status])
}

model HireRequest {
  id            String   @id @default(cuid())
  serviceId     String
  buyerId       String
  sellerId      String
  price         Float
  currency      String   @default("PNCR")
  requirements  String?  @db.Text
  status        String   @default("pending") // pending, accepted, rejected, in_progress, delivered, challenge, completed, disputed, cancelled
  escrowId      String?
  chatRoomId    String?
  deliveredAt   DateTime?      // When seller marks as delivered
  challengeEnd  DateTime?      // 2 hours after delivery for disputes
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  service       Service  @relation(fields: [serviceId], references: [id])
  buyer         User     @relation("HireBuyer", fields: [buyerId], references: [id])
  seller        User     @relation("HireSeller", fields: [sellerId], references: [id])

  @@index([serviceId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

// ============================================
// PNCR Purchase Requests
// ============================================

model PurchaseRequest {
  id            String    @id @default(cuid())
  userId        String
  txHash        String    @unique
  fromToken     String    // ETH, USDT, USDC
  fromAmount    String
  toPNCR        Float
  walletAddress String
  status        String    @default("pending") // pending, verified, credited, failed
  createdAt     DateTime  @default(now())
  verifiedAt    DateTime?
  creditedAt    DateTime?

  user          User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([txHash])
  @@index([status])
}

// ============================================
// Agent Reviews (Enhanced)
// ============================================

model AgentReview {
  id            String   @id @default(cuid())
  agentId       String
  userId        String
  hireRequestId String?  @unique
  rating        Int      // 1-5
  title         String
  content       String   @db.Text
  helpful       Int      @default(0)
  verified      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation("AgentReviewsGiven", fields: [userId], references: [id])

  @@unique([agentId, userId])
  @@index([agentId])
  @@index([userId])
  @@index([rating])
}

// ============================================
// Package Purchases (Pioneer/Builder/Contributor)
// ============================================

model PackagePurchase {
  id            String   @id @default(cuid())
  userId        String
  packageId     String   // pioneer, builder, contributor
  txHash        String   @unique
  pncrAmount    Float
  priceETH      String
  status        String   @default("confirmed") // pending, confirmed, refunded
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([packageId])
}

// ============================================
// Quest Completions
// ============================================

model QuestCompletion {
  id            String   @id @default(cuid())
  userId        String
  questId       String
  reward        Float
  completedAt   DateTime @default(now())

  @@unique([userId, questId], name: "uniqueUserQuest")
  @@index([userId])
  @@index([questId])
}

// ============================================
// Dispute Resolution (Jury System)
// ============================================

model Dispute {
  id              String   @id @default(cuid())
  hireRequestId   String   @unique
  raisedById      String   // Who raised the dispute (usually buyer)
  reason          String   @db.Text
  evidence        String?  @db.Text // JSON array of evidence URLs/descriptions
  sellerResponse  String?  @db.Text
  status          String   @default("open") // open, voting, resolved, expired
  resolution      String?  // buyer_wins, seller_wins, split
  votingEndsAt    DateTime?
  resolvedAt      DateTime?
  buyerAmount     Float?   // Amount returned to buyer if resolved
  sellerAmount    Float?   // Amount given to seller if resolved
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  votes           DisputeVote[]

  @@index([hireRequestId])
  @@index([status])
}

model DisputeVote {
  id          String   @id @default(cuid())
  disputeId   String
  voterId     String   // Must be a staker
  vote        String   // buyer, seller
  stakeWeight Float    // Voting power based on stake amount
  reason      String?
  createdAt   DateTime @default(now())

  dispute     Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@unique([disputeId, voterId])
  @@index([disputeId])
  @@index([voterId])
}

// ============================================
// Favorites / Watchlist
// ============================================

model Favorite {
  id            String   @id @default(cuid())
  userId        String
  targetType    String   // agent, service, soul
  targetId      String
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId])
  @@index([userId])
  @@index([targetType, targetId])
}
